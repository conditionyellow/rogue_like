# Rogue - The Dungeon Crawler
## ゲーム仕様書 (Game Specification)

### 📋 概要 (Overview)
**Rogue - The Dungeon Crawler** は、クラシックなRoguelikeゲームをWebブラウザ上で再現したターンベースのダンジョン探索RPGです。プレイヤーは自動生成されるダンジョンを探索し、モンスターと戦い、アイテムを収集しながらキャラクターを成長させていきます。

---

## 🎮 基本仕様 (Core Specifications)

### システム要件
- **プラットフォーム**: Webブラウザ（HTML5 Canvas対応）
- **言語**: JavaScript (ES6+)
- **依存関係**: なし（Pure JavaScript実装）
- **対応ブラウザ**: Chrome, Firefox, Safari, Edge（モダンブラウザ）

### 画面解像度・表示
- **キャンバスサイズ**: 640×640ピクセル
- **タイルサイズ**: 16×16ピクセル
- **表示範囲**: 40×40タイル（カメラはプレイヤーを中心に追従）
- **UI配置**: ゲーム画面（左）+ 情報パネル（右）

---

## 🗺️ ダンジョンシステム (Dungeon System)

### マップ生成アルゴリズム
1. **初期化**: 40×40のマップを全て壁（`#`）で埋める
2. **部屋生成**: 5〜9個のランダムな矩形部屋を配置
   - 部屋サイズ: 4×4 〜 7×7タイル
   - 重複チェック: 部屋同士の重複を防止
3. **通路生成**: 隣接する部屋を直線的な通路で接続
   - L字型通路（水平→垂直の順）
4. **階段配置**: 最後に生成された部屋の中央に下り階段（`S`）を配置

### タイル種類
| タイル | 記号 | 説明 | 色 |
|--------|------|------|-----|
| 壁 | `#` | 移動不可の壁 | `#000000` (黒) |
| 床 | `.` | 移動可能なフロア | `#FFFFFF` (白) |
| 階段 | `S` | 次の階への移動ポイント | `#000000` (黒) |

---

## 👤 キャラクターシステム (Character System)

### プレイヤーキャラクター
- **表示記号**: `@`
- **色**: `#000000` (黒)
- **初期配置**: 最初に生成された部屋の中央

#### 基本ステータス
| ステータス | 初期値 | 説明 |
|------------|--------|------|
| Level | 1 | キャラクターレベル |
| HP | 100/100 | ヒットポイント（体力） |
| MP | 50/50 | マジックポイント（魔力） |
| Attack | 10 | 攻撃力 |
| Defense | 5 | 防御力 |
| Experience | 0 | 経験値 |
| Gold | 0 | 所持金 |

#### レベルアップシステム
- **必要経験値**: 初回100、以後1.5倍ずつ増加
- **レベルアップ効果**:
  - HP最大値: +8〜14 (ランダム)
  - MP最大値: +3〜7 (ランダム)  
  - Attack: +1〜2 (ランダム)
  - Defense: +1〜1 (ランダム)
  - HP/MP完全回復

### 敵キャラクター

#### ゴブリン (`g`)
- **HP**: 15
- **Attack**: 5  
- **Defense**: 1
- **経験値**: 10
- **ドロップ金額**: 5
- **色**: `#666666` (グレー)

#### オーク (`o`)
- **HP**: 25
- **Attack**: 8
- **Defense**: 3  
- **経験値**: 20
- **ドロップ金額**: 10
- **色**: `#666666` (グレー)

#### スケルトン (`s`)
- **HP**: 20
- **Attack**: 7
- **Defense**: 2
- **経験値**: 15  
- **ドロップ金額**: 8
- **色**: `#666666` (グレー)

#### 敵AI仕様
1. **索敵**: プレイヤーとの距離を計算
2. **移動**: プレイヤーに向かって1タイルずつ移動
3. **攻撃**: プレイヤーと隣接時に自動攻撃
4. **移動制限**: 壁・他の敵・プレイヤーの位置は移動不可
5. **移動順序**: X軸・Y軸の移動をランダムに選択

---

## ⚔️ 戦闘システム (Combat System)

### 戦闘フロー
1. **戦闘開始**: プレイヤーが敵に隣接した位置に移動
2. **ダメージ計算**: `max(1, 攻撃力 - 防御力 + ランダム(-2〜+2))`
3. **HP減算**: 計算されたダメージをHPから減算
4. **死亡判定**: HP ≤ 0で死亡
5. **報酬**: 敵が死亡時、経験値・金額を獲得

### 戦闘メッセージ
- プレイヤー攻撃: `"You hit [敵名] for [ダメージ] damage!"`
- 敵攻撃: `"[敵名] hits you for [ダメージ] damage!"`  
- 敵死亡: `"[敵名] dies!"`
- プレイヤー死亡: `"You have died! Game Over."`

---

## 🎒 アイテムシステム (Item System)

### アイテム管理
- **グローバルアイテムID**: 全てのアイテムにユニークな数値IDを自動割り当て
- **重複防止システム**: アイテム拾得・装備変更時に新しいIDを生成
- **安全削除機能**: ID照合による確実なアイテム削除とエラーログ出力

### アイテム種類

#### 回復アイテム
| アイテム名 | 記号 | 効果 | 数値 | 色 |
|------------|------|------|------|-----|
| Health Potion | `!` | HP回復 | +30 | `#333333` (ダークグレー) |
| Mana Potion | `!` | MP回復 | +20 | `#333333` (ダークグレー) |

#### 装備アイテム
| アイテム名 | 記号 | 効果 | 数値 | 色 |
|------------|------|------|------|-----|
| Sword | `/` | 攻撃力上昇 | +5 | `#333333` (ダークグレー) |
| Shield | `]` | 防御力上昇 | +3 | `#333333` (ダークグレー) |

#### 通貨
| アイテム名 | 記号 | 効果 | 数値 | 色 |
|------------|------|------|------|-----|
| Gold Coin | `$` | 所持金増加 | +25 | `#333333` (ダークグレー) |

### アイテム使用システム

#### **2つの使用方法**
1. **直接使用（ダイレクトアクセス）**
   - キー: `1`～`9`
   - 機能: インベントリの指定位置のアイテムを即座に使用
   - 利点: 素早い操作、戦闘中の緊急使用に最適

2. **選択モード（インタラクティブ）**
   - キー: `U` → `1`～`9` または `ESC`でキャンセル
   - 機能: アイテム詳細情報と効果値を表示してから選択
   - 利点: 各アイテムの効果を確認してから使用可能

#### **使用制限・智能判定**
- **HP満タン時**: Health Potionの使用を自動拒否
- **MP満タン時**: Mana Potionの使用を自動拒否
- **装備重複防止**: 同じアイテムの再装備を自動検出・拒否
- **インベントリ範囲外**: 存在しないアイテム番号の指定を自動拒否

### アイテム配置
- **配置確率**: 各部屋60%の確率でアイテム1個配置
- **配置位置**: 部屋内のランダムな床タイル
- **選択**: アイテム種類はランダム選択

### 装備システム
- **装備スロット**: 武器（weapon）・防具（armor）の2スロット
- **装備交換**: 新装備時に既存装備を自動でインベントリに戻す
- **ステータス計算**: 基本値＋装備ボーナスをリアルタイム計算
- **装備表示**: 装備中のアイテム情報とボーナス値を詳細表示

---

## 🎯 ゲームプレイ (Gameplay)

### 操作方法
| キー | 動作 | 詳細 |
|------|------|------|
| `W` / `↑` | 上移動 | 1タイル上に移動 |
| `S` / `↓` | 下移動 | 1タイル下に移動 |  
| `A` / `←` | 左移動 | 1タイル左に移動 |
| `D` / `→` | 右移動 | 1タイル右に移動 |
| `Space` | 休憩 | HP+2, MP+1回復 |
| `G` | アイテム取得 | 足元のアイテムを拾う |
| **`U`** | **アイテム選択モード** | **インタラクティブなアイテム選択画面を開く** |
| **`1`～`9`** | **直接アイテム使用** | **インベントリの指定番号のアイテムを即座に使用** |
| **`I`** | **インベントリUI** | **専用のインベントリ画面を表示（モダンUI）** |
| `E` | 装備表示 | 現在装備中の武器・防具を表示 |
| `R` | 装備除去 | 装備中のアイテムを外してインベントリに戻す |
| `ESC` | キャンセル | アイテム選択モード・インベントリUIを終了 |

### ターンシステム
1. **プレイヤーフェーズ**: プレイヤーが1アクション実行
2. **敵フェーズ**: 全ての生存している敵が1回ずつ行動  
3. **ターン終了**: ターン数を1増加し、次のプレイヤーフェーズへ

### 階層進行システム
- **階層表示**: UI右上に現在の階層（Floor）番号を表示
- **階段発見**: ダンジョン最深部の部屋中央に下り階段（`>`記号）を配置
- **深層進行**: 階段上で自動的に次の階層へ移動
- **完全再生成**: 新階層では敵・アイテム・マップを完全にリセット
- **プレイヤー配置**: 新階層では最初の部屋の中央からスタート

### 勝利条件・敗北条件
- **勝利条件**: なし（無限プレイ・階層制限なし）
- **敗北条件**: プレイヤーのHP ≤ 0
- **継続条件**: 階段（`S`）で次の階層へ移動可能

---

## 🎨 デザイン・UI仕様 (Design & UI Specifications)

### カラーパレット
本ゲームは極限までシンプルにしたミニマリスト配色を採用しています。

#### ゲーム要素の色
| 要素 | 色 | 備考 |
|------|----|----|
| 背景（床） | `#FFFFFF` (白) | ダンジョンの床部分 |
| 壁・障害物 | `#000000` (黒) | 移動不可エリア |
| プレイヤー | `#000000` (黒) | 白い床に映える黒いキャラクター |
| 敵 | `#666666` (グレー) | プレイヤーと区別できる中間色 |
| アイテム | `#333333` (ダークグレー) | 控えめながら認識できる色 |
| 階段 | `#000000` (黒) | 重要な移動ポイント |

#### UI要素の色
| 要素 | 色 | 備考 |
|------|----|----|
| UI背景 | `#FFFFFF` (白) | 清潔感のある背景 |
| UI枠線 | `#000000` (黒) | はっきりとした区切り |
| テキスト（基本） | `#000000` (黒) | 主要な情報表示 |
| テキスト（システム） | `#666666` (グレー) | 補助的な情報 |
| テキスト（戦闘） | `#333333` (ダークグレー) | 戦闘ログ |
| ヘルスバー | `#000000` (黒) | 体力ゲージ |
| マナバー | `#333333` (ダークグレー) | 魔力ゲージ |

### レイアウト設計
- **レスポンシブ対応**: モバイルから大画面まで対応
- **センタリング**: ゲーム画面を中央配置、スクロール不要
- **固定比率**: ゲーム画面とUI情報パネルの比率を最適化
- **等幅フォント**: `Courier New` でレトロゲーム感を演出

---

## 💻 技術仕様 (Technical Specifications)

### クラス構造

#### `Game`クラス（メインゲームエンジン）
```javascript
class Game {
    // コンストラクタ・初期化
    constructor()
    init()
    setupEventListeners()
    
    // ゲームループ・入力処理
    handleInput(e)
    handleItemSelection(e)    // 新機能: アイテム選択モード
    processTurn()
    
    // プレイヤー制御
    movePlayer(dx, dy)
    pickupItem()
    useItem()                 // 旧来のアイテム使用
    
    // 新アイテムシステム
    startItemSelection()      // アイテム選択モード開始
    useItemByIndex(index)     // インデックス指定使用
    removeItemFromInventory(itemId) // 安全なアイテム削除
    
    // 装備システム
    equipItem(item)
    unequipItem(slot)
    showEquipment()
    removeEquipment()
    updatePlayerStats()
    
    // 戦闘・レベリング
    combat(attacker, defender)
    checkLevelUp()
    
    // ダンジョン・階層管理
    generateDungeon()
    descendStairs()           // 新機能: 階層進行
    carveRoom(room)
    connectRooms(room1, room2)
    
    // エンティティ管理
    createPlayer()
    spawnEnemies()
    spawnItems()
    
    // レンダリング・UI
    render()
    renderTile(x, y, tile)
    renderEntity(x, y, symbol, color)
    updateUI()
    addMessage(text, type)
    updateMessages()
    toggleInventory()
    
    // 新インベントリUIシステム（新機能）
    showInventoryUI()         // 専用インベントリUIを表示
    hideInventoryUI()         // インベントリUIを非表示
    createInventoryUI()       // インベントリUIの作成
    createInventoryItemElement() // アイテム要素の作成
    updateInventoryUI()       // インベントリUIの更新
    removeInventoryUI()       // インベントリUIの削除
    handleInventoryInput()    // インベントリUI内での入力処理
    dropItem()                // アイテムドロップ機能
    
    // ユーティリティ
    random(min, max)
    gameOver()
}
```

### データ構造

#### ゲームステート
```javascript
game = {
    canvas: HTMLCanvasElement,    // ゲーム描画キャンバス
    ctx: CanvasRenderingContext2D, // 描画コンテキスト
    tileSize: 16,                 // タイル1つのピクセルサイズ
    mapWidth: 40,                 // マップ幅（タイル数）
    mapHeight: 40,                // マップ高さ（タイル数）
    viewWidth: number,            // 表示範囲幅
    viewHeight: number,           // 表示範囲高さ
    
    player: Object,               // プレイヤーオブジェクト
    dungeon: Array[Array],        // 2次元マップ配列
    entities: Array,              // 敵エンティティ配列
    items: Array,                 // アイテム配列
    rooms: Array,                 // 部屋情報配列
    
    turn: number,                 // 現在ターン数
    floor: number,                // 現在階層（新機能）
    gameState: string,            // ゲーム状態 ('playing', 'dead')
    itemSelectionMode: boolean,   // アイテム選択モード中フラグ（新機能）
    inventoryUIActive: boolean,   // インベントリUI表示フラグ（新機能）
    nextItemId: number,           // グローバルアイテムIDカウンター（新機能）
    
    messages: Array,              // メッセージログ
    maxMessages: 50,              // 最大メッセージ保持数
    colors: Object                // カラーパレット定義
}
```

#### プレイヤーオブジェクト
```javascript
player = {
    x: number,           // X座標
    y: number,           // Y座標  
    hp: number,          // 現在HP
    maxHp: number,       // 最大HP
    mp: number,          // 現在MP
    maxMp: number,       // 最大MP
    baseAttack: number,  // 基本攻撃力（新機能）
    baseDefense: number, // 基本防御力（新機能）
    attack: number,      // 計算済み攻撃力（基本値+装備ボーナス）
    defense: number,     // 計算済み防御力（基本値+装備ボーナス）
    level: number,       // レベル
    experience: number,  // 現在経験値
    experienceToNext: number, // 次のレベルまでの必要経験値
    gold: number,        // 所持金
    inventory: Array,    // アイテム配列
    equipment: {         // 装備スロット
        weapon: Object,  // 装備中の武器
        armor: Object    // 装備中の防具
    },
    symbol: string,      // 表示記号
    color: string,       // 表示色
    rest: function       // 休憩メソッド
}
```

#### 敵オブジェクト
```javascript
enemy = {
    name: string,        // 敵の名前
    symbol: string,      // 表示記号
    x: number,           // X座標
    y: number,           // Y座標
    hp: number,          // HP
    attack: number,      // 攻撃力
    defense: number,     // 防御力
    experience: number,  // 与える経験値
    gold: number,        // ドロップ金額
    type: 'enemy',       // エンティティ種別
    alive: boolean,      // 生存状態
    color: string        // 表示色
}
```

#### アイテムオブジェクト
```javascript
item = {
    name: string,        // アイテム名
    symbol: string,      // 表示記号
    x: number,           // X座標（マップ上配置時）
    y: number,           // Y座標（マップ上配置時）
    type: string,        // アイテム種別 ('potion', 'weapon', 'armor', 'gold')
    effect: string,      // 効果種別 ('heal', 'mana')
    value: number,       // 効果値・金額
    attack: number,      // 武器の攻撃力ボーナス
    defense: number,     // 防具の防御力ボーナス
    color: string,       // 表示色
    id: number           // 一意識別子（新機能: グローバルカウンター）
}
```

### アイテムID管理システム（新機能）
```javascript
// グローバルアイテムIDシステム
this.nextItemId = 0;  // ゲーム開始時に0で初期化

// アイテム生成時
item.id = this.nextItemId++;  // 自動インクリメント

// 安全な削除メソッド
removeItemFromInventory(itemId) {
    // ID照合による確実な削除
    // 削除前後の詳細ログ出力
    // エラーハンドリングと警告
}
```

### 描画システム
- **Canvas API**: HTML5 Canvasを使用した2D描画
- **フォント**: `monospace`（等幅フォント）
- **カメラシステム**: プレイヤー中心の追従カメラ
- **座標系**: ワールド座標とスクリーン座標の変換

### メッセージシステム
- **最大保持数**: 50メッセージ
- **表示数**: 最新10メッセージ
- **種類**: `system`, `combat`, `item`
- **色分け**: 種類別の色分け表示
- **自動スクロール**: 新メッセージ追加時に自動で最下部にスクロール

### アイテム選択UI（新機能）
- **選択モード表示**: `U`キー押下時に詳細なアイテム一覧を表示
- **効果値表示**: 各アイテムの具体的な効果数値を表示
  - 例: `"1: ! Health Potion (HP +30)"`
  - 例: `"2: / Sword (Attack +5)"`
- **操作案内**: 使用方法とキャンセル方法を明示
- **即座使用**: 数字キー（1-9）による直接アイテム使用

### インベントリUIシステム（新機能）
- **専用オーバーレイ**: `I`キー押下時にモダンなインベントリ画面を表示
- **インタラクティブ操作**: 
  - クリックによるアイテム使用・装備
  - Use/Equip/Unequip/Dropボタンによる詳細操作
  - キーボード操作（1-9キーでの直接使用、ESCでクローズ）
- **視覚的表示**: 
  - アイテムアイコン・名前・効果値の詳細表示
  - 装備中アイテムの [EQUIPPED] ラベル表示
  - 装備中アイテムのボーダー強調表示
- **智能制限表示**: 
  - HP/MP満タン時の使用不可表示
  - 使用不可時のボタン無効化
- **レスポンシブ対応**: モバイル・デスクトップ両対応のUI設計

### デバッグ・ログシステム（新機能）
- **アイテム操作ログ**: アイテムの追加・削除・使用をコンソールログに詳細出力
- **ID追跡**: 各アイテムのユニークIDを追跡・表示
- **エラー検出**: アイテム削除失敗時の詳細警告とインベントリ状態出力
- **デバッグ情報**: インベントリ内容の詳細表示（アイテム名+ID）

---

## 🔧 拡張予定機能 (Future Enhancements)

### 優先度: 高
- [x] **装備システム**: 武器・防具の実装 ✅
- [x] **アイテム選択システム**: インタラクティブなアイテム使用 ✅
- [x] **階層進行システム**: フロア移動と表示 ✅
- [x] **アイテムID管理**: 重複防止とデバッグ強化 ✅
- [x] **インベントリUI**: 専用インベントリ画面 ✅
- [x] **レイアウト最適化**: ダンジョン表示領域とステータス領域の高さ統一 ✅
- [ ] **セーブ/ロード**: ローカルストレージによるゲーム保存
- [ ] **サウンド**: 効果音・BGMの追加

### 優先度: 中
- [ ] **魔法システム**: MPを消費するスキル
- [ ] **罠システム**: ダンジョン内の仕掛け
- [ ] **ショップ**: 金額でアイテム購入
- [ ] **ボスモンスター**: 強力な敵キャラクター

### 優先度: 低  
- [ ] **視界システム**: Fog of War（霧戦争）
- [ ] **地形バリエーション**: 水・溶岩・氷などの特殊地形
- [ ] **クエストシステム**: 目標・報酬システム
- [ ] **マルチプレイ**: オンライン協力プレイ

---

## 🐛 既知の問題・制限事項 (Known Issues & Limitations)

### 既知の問題（修正済み）
1. ~~**敵AI**: 単純な追跡のみ（戦術的行動なし）~~ → 現在も該当
2. ~~**インベントリ**: アイテムの個別使用が不可（ポーションのみ自動選択）~~ → ✅ **修正完了**: アイテム選択システム実装
3. ~~**バランス**: レベルアップによる難易度調整が不十分~~ → 現在も該当
4. ~~**アイテム重複・消失バグ**~~ → ✅ **修正完了**: IDシステムと安全削除で解決

### 現在の問題・制限事項
1. **敵AI**: 単純な追跡のみ（戦術的行動なし）
2. **バランス**: 階層進行に応じた難易度スケーリングなし  
3. **UI操作**: モバイル端末でのタッチ操作未対応
4. **アイテム種類**: 限定的なアイテムバリエーション

### 技術的制限
1. **保存機能**: ページリロードでデータ消失
2. **モバイル対応**: タッチ操作に未対応
3. **解像度**: 固定解像度のみ対応
4. **パフォーマンス**: 大量のエンティティ時の最適化不足

### 仕様制限
1. **マップサイズ**: 40×40固定
2. **同時敵数**: 部屋数×最大3体の制限
3. **アイテム種類**: 5種類のみ
4. **階層数**: 無制限だが進行に変化なし

---

## 📊 バランス調整データ (Balance Data)

### 経験値テーブル
| Level | 必要経験値 | 累計経験値 |
|-------|------------|------------|
| 1→2 | 100 | 100 |
| 2→3 | 150 | 250 |
| 3→4 | 225 | 475 |
| 4→5 | 337 | 812 |
| 5→6 | 505 | 1317 |

### ダメージ計算例
```
プレイヤー(Attack: 10) vs ゴブリン(Defense: 1)
基本ダメージ = 10 - 1 = 9
ランダム修正 = -2 〜 +2
最終ダメージ = 7 〜 11 (最低保証: 1)
```

---

## 📝 更新履歴 (Change Log)

### Version 1.0.0 (2025-06-04)
- ✅ 基本ゲームシステム実装
- ✅ ダンジョン自動生成
- ✅ ターンベース戦闘
- ✅ レベルアップシステム
- ✅ 基本アイテムシステム
- ✅ UI・メッセージシステム

### Version 1.1.0 (2025-06-04) - ⚔️ **装備システム基盤実装**
- ✅ **装備システム完全実装**
  - 武器・防具の装備/脱着機能
  - ステータスへの装備効果反映
  - 装備スロット管理（weapon/armor）
  - 装備表示機能（Eキー）
  - 装備除去機能（Rキー）
  - 基本ステータスと計算済みステータスの分離
  - レベルアップ時の装備効果保持

### Version 1.2.0 (2025-06-04) - 🎯 **アイテム選択システム実装**
- ✅ **高度なアイテムシステム完全実装**
  - **2つのアイテム使用方法**: ダイレクトアクセス（1-9キー）＋選択モード（Uキー）
  - **詳細情報表示**: アイテム効果値の表示（HP+30、Attack+5など）
  - **智能判定システム**: HP/MP満タン時の使用制限、装備重複防止
  - **安全なアイテム管理**: グローバルIDシステムでアイテム重複・消失バグを完全解決
  - **デバッグ強化**: 詳細なログ出力とエラーハンドリング

### Version 1.3.0 (2025-06-04) - 🎨 **インベントリUI・レイアウト最適化実装**
- ✅ **専用インベントリUIシステム完全実装**
  - **モダンなUI設計**: オーバーレイ表示による専用インベントリ画面
  - **インタラクティブ操作**: クリック操作とキーボード操作の両対応
  - **視覚的情報表示**: アイテムアイコン、名前、効果値、装備状態の詳細表示
  - **smart操作制限**: HP/MP満タン時の使用制限表示、ボタン無効化
  - **多様な操作方法**: Use/Equip/Unequip/Drop ボタン + 直接クリック操作
  - **[EQUIPPED]ラベル**: 装備中アイテムの明確な視覚的区別
  - **ボーダー強調**: 装備中アイテムの枠線強調表示
- ✅ **レイアウト最適化完全実装**  
  - **高さ統一**: ゲームキャンバス（640x640px）と情報パネル（640px高）の完全統一
  - **レスポンシブ強化**: モバイル・タブレット・デスクトップの最適化
  - **バランス改善**: 視覚的バランスとプロフェッショナルな外観の向上

---

*この仕様書は開発の進行に合わせて随時更新されます。*
