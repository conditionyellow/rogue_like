# Rogue - The Dungeon Crawler
## ゲーム仕様書 (Game Specification)

### 📋 概要 (Overview)
**Rogue - The Dungeon Crawler** は、クラシックなRoguelikeゲームをWebブラウザ上で再現したターンベースのダンジョン探索RPGです。プレイヤーは自動生成されるダンジョンを探索し、モンスターと戦い、アイテムを収集しながらキャラクターを成長させていきます。

---

## 🎮 基本仕様 (Core Specifications)

### システム要件
- **プラットフォーム**: Webブラウザ（HTML5 Canvas対応）
- **言語**: JavaScript (ES6+)
- **依存関係**: なし（Pure JavaScript実装）
- **対応ブラウザ**: Chrome, Firefox, Safari, Edge（モダンブラウザ）
- **サウンド**: Web Audio API（プロシージャル音響生成）

### 画面解像度・表示
- **キャンバスサイズ**: 640×640ピクセル
- **タイルサイズ**: 16×16ピクセル
- **表示範囲**: 40×40タイル（カメラはプレイヤーを中心に追従）
- **UI配置**: ゲーム画面（左）+ 情報パネル（右）

---

## 🗺️ ダンジョンシステム (Dungeon System)

### マップ生成アルゴリズム
1. **初期化**: 40×40のマップを全て壁（`#`）で埋める
2. **部屋生成**: 5〜9個のランダムな矩形部屋を配置
   - 部屋サイズ: 4×4 〜 7×7タイル
   - 重複チェック: 部屋同士の重複を防止
3. **通路生成**: 隣接する部屋を直線的な通路で接続
   - L字型通路（水平→垂直の順）
4. **階段配置**: 最後に生成された部屋の中央に下り階段（`S`）を配置

### タイル種類
| タイル | 記号 | 説明 | 色 |
|--------|------|------|-----|
| 壁 | `#` | 移動不可の壁 | `#000000` (黒) |
| 床 | `.` | 移動可能なフロア | `#FFFFFF` (白) |
| 階段 | `%` | 次の階への移動ポイント | `#000000` (黒) |

---

## 👤 キャラクターシステム (Character System)

### プレイヤーキャラクター
- **表示記号**: `@`
- **色**: `#000000` (黒)
- **初期配置**: 最初に生成された部屋の中央

#### 基本ステータス
| ステータス | 初期値 | 説明 |
|------------|--------|------|
| Level | 1 | キャラクターレベル |
| HP | 100/100 | ヒットポイント（体力） |
| MP | 50/50 | マジックポイント（魔力） |
| Attack | 10 | 攻撃力 |
| Defense | 5 | 防御力 |
| Experience | 0 | 経験値 |
| Gold | 0 | 所持金 |

#### レベルアップシステム
- **必要経験値**: 初回100、以後1.5倍ずつ増加
- **レベルアップ効果**:
  - HP最大値: +8〜14 (ランダム)
  - MP最大値: +3〜7 (ランダム)  
  - Attack: +1〜2 (ランダム)
  - Defense: +1〜1 (ランダム)
  - HP/MP完全回復

### 敵キャラクター

#### ゴブリン (`g`)
- **HP**: 15
- **Attack**: 5  
- **Defense**: 1
- **経験値**: 10
- **ドロップ金額**: 5
- **色**: `#666666` (グレー)

#### オーク (`o`)
- **HP**: 25
- **Attack**: 8
- **Defense**: 3  
- **経験値**: 20
- **ドロップ金額**: 10
- **色**: `#666666` (グレー)

#### スケルトン (`s`)
- **HP**: 20
- **Attack**: 7
- **Defense**: 2
- **経験値**: 15  
- **ドロップ金額**: 8
- **色**: `#666666` (グレー)

#### 敵AI仕様
1. **索敵**: プレイヤーとの距離を計算
2. **移動**: プレイヤーに向かって1タイルずつ移動
3. **攻撃**: プレイヤーと隣接時に自動攻撃
4. **移動制限**: 壁・他の敵・プレイヤーの位置は移動不可
5. **移動順序**: X軸・Y軸の移動をランダムに選択

---

## ⚔️ 戦闘システム (Combat System)

### 戦闘フロー
1. **戦闘開始**: プレイヤーが敵に隣接した位置に移動
2. **ダメージ計算**: `max(1, 攻撃力 - 防御力 + ランダム(-2〜+2))`
3. **HP減算**: 計算されたダメージをHPから減算
4. **死亡判定**: HP ≤ 0で死亡
5. **報酬**: 敵が死亡時、経験値・金額を獲得

### 戦闘メッセージ
- プレイヤー攻撃: `"You hit [敵名] for [ダメージ] damage!"`
- 敵攻撃: `"[敵名] hits you for [ダメージ] damage!"`  
- 敵死亡: `"[敵名] dies!"`
- プレイヤー死亡: `"You have died! Game Over."`

---

## 🎒 アイテムシステム (Item System)

### アイテム管理
- **グローバルアイテムID**: 全てのアイテムにユニークな数値IDを自動割り当て
- **重複防止システム**: アイテム拾得・装備変更時に新しいIDを生成
- **安全削除機能**: ID照合による確実なアイテム削除とエラーログ出力

### アイテム種類

#### 回復アイテム
| アイテム名 | 記号 | 効果 | 数値 | 色 |
|------------|------|------|------|-----|
| Health Potion | `!` | HP回復 | +30 | `#333333` (ダークグレー) |
| Mana Potion | `!` | MP回復 | +20 | `#333333` (ダークグレー) |

#### 装備アイテム
| アイテム名 | 記号 | 効果 | 数値 | 色 |
|------------|------|------|------|-----|
| Sword | `)` | 攻撃力上昇 | +5 | `#333333` (ダークグレー) |
| Shield | `]` | 防御力上昇 | +3 | `#333333` (ダークグレー) |

#### 通貨
| アイテム名 | 記号 | 効果 | 数値 | 色 |
|------------|------|------|------|-----|
| Gold Coin | `*` | 所持金増加 | +25 | `#333333` (ダークグレー) |

### アイテム使用システム

#### **2つの使用方法**
1. **直接使用（ダイレクトアクセス）**
   - キー: `1`～`9`
   - 機能: インベントリの指定位置のアイテムを即座に使用
   - 利点: 素早い操作、戦闘中の緊急使用に最適

2. **選択モード（インタラクティブ）**
   - キー: `U` → `1`～`9` または `ESC`でキャンセル
   - 機能: アイテム詳細情報と効果値を表示してから選択
   - 利点: 各アイテムの効果を確認してから使用可能

#### **使用制限・智能判定**
- **HP満タン時**: Health Potionの使用を自動拒否
- **MP満タン時**: Mana Potionの使用を自動拒否
- **装備重複防止**: 同じアイテムの再装備を自動検出・拒否
- **インベントリ範囲外**: 存在しないアイテム番号の指定を自動拒否

### アイテム配置
- **配置確率**: 各部屋60%の確率でアイテム1個配置
- **配置位置**: 部屋内のランダムな床タイル
- **選択**: アイテム種類はランダム選択

### 装備システム
- **装備スロット**: 武器（weapon）・防具（armor）の2スロット
- **装備交換**: 新装備時に既存装備を自動でインベントリに戻す
- **ステータス計算**: 基本値＋装備ボーナスをリアルタイム計算
- **装備表示**: 装備中のアイテム情報とボーナス値を詳細表示

---

## 🎯 ゲームプレイ (Gameplay)

### 操作方法
| キー | 動作 | 詳細 |
|------|------|------|
| `W` / `↑` | 上移動 | 1タイル上に移動 |
| `S` / `↓` | 下移動 | 1タイル下に移動 |  
| `A` / `←` | 左移動 | 1タイル左に移動 |
| `D` / `→` | 右移動 | 1タイル右に移動 |
| `Space` | 休憩 | HP+2, MP+1回復 |
| `G` | アイテム取得 | 足元のアイテムを拾う |
| **`U`** | **アイテム選択モード** | **インタラクティブなアイテム選択画面を開く** |
| **`1`～`9`** | **直接アイテム使用** | **インベントリの指定番号のアイテムを即座に使用** |
| **`I`** | **インベントリUI** | **専用のインベントリ画面を表示（モダンUI）** |
| `E` | 装備表示 | 現在装備中の武器・防具を表示 |
| `R` | 装備除去 | 装備中のアイテムを外してインベントリに戻す |
| `ESC` | キャンセル | アイテム選択モード・インベントリUIを終了 |
| **`V`** | **音量調整** | **サウンドシステムの音量を調整** |
| **`M`** | **ミュート** | **サウンドシステムのミュート切り替え** |
| **`R`** | **ゲーム再開** | **GAMEOVER画面表示時に新しいゲームを開始** |

### ターンシステム
1. **プレイヤーフェーズ**: プレイヤーが1アクション実行
2. **敵フェーズ**: 全ての生存している敵が1回ずつ行動  
3. **ターン終了**: ターン数を1増加し、次のプレイヤーフェーズへ

### 階層進行システム
- **階層表示**: UI右上に現在の階層（Floor）番号を表示
- **階段発見**: ダンジョン最深部の部屋中央に下り階段（`>`記号）を配置
- **深層進行**: 階段上で自動的に次の階層へ移動
- **完全再生成**: 新階層では敵・アイテム・マップを完全にリセット
- **プレイヤー配置**: 新階層では最初の部屋の中央からスタート

### 勝利条件・敗北条件
- **勝利条件**: なし（無限プレイ・階層制限なし）
- **敗北条件**: プレイヤーのHP ≤ 0
- **継続条件**: 階段（`S`）で次の階層へ移動可能

### GAMEOVER画面システム（新機能）
本ゲームはクラシックなRogue（rogue5.4.4-ant-r1.1.2）の伝統的な死亡画面を現代的にアレンジしたGAMEOVER画面を実装しています。

#### **表示内容**
- **ASCII墓石アート**: オリジナルRogueから継承された伝統的なASCII墓石デザイン
- **死亡原因**: プレイヤーを倒したモンスター名を表示（"Killed by a goblin"形式）
- **最終スコア**: ゲームプレイの総合評価点数
- **詳細統計情報**:
  - **Level**: 達成レベル
  - **Floor**: 到達階層
  - **Turns**: 総プレイターン数
  - **Gold**: 所持金額
  - **Experience**: 獲得経験値
  - **Monsters defeated**: 倒したモンスター数
  - **Items found**: 発見したアイテム数
- **装備情報**: 死亡時に装備していた武器・防具

#### **スコア計算システム**
```javascript
最終スコア = (Gold × 5) + (Experience × 2) + (Level × 100) + 
            (Floor × 50) - (Turns × 0.1) + 装備ボーナス

装備ボーナス = (武器攻撃力 × 20) + (防具防御力 × 15)
```

#### **レスポンシブデザイン**
- **大画面対応**: 標準サイズ（画面高700px以上）での最適表示
- **小画面対応**: 自動判定（画面高700px未満）でのコンパクト表示
  - フォントサイズの動的調整
  - パディングの最適化
  - スクロール機能の自動有効化
- **モバイル対応**: タッチデバイスでの操作性最適化

#### **インタラクション**
- **キーボード操作**:
  - `R`: ゲーム再開（新しいゲームで最初から）
  - `ESC`: GAMEOVER画面を閉じる
- **マウス/タッチ操作**: 各ボタンのクリック/タップ対応
- **表示タイミング**: プレイヤー死亡から1秒後に自動表示

#### **技術仕様**
- **モーダルオーバーレイ**: 半透明背景による没入的表示
- **動的コンテンツ生成**: JavaScript DOM操作による柔軟な画面構築
- **イベントハンドリング**: キーボード・マウス両対応の統合操作システム
- **メモリ管理**: 画面クローズ時の完全なクリーンアップ処理

---

## 🎨 デザイン・UI仕様 (Design & UI Specifications)

### カラーパレット
本ゲームは目に優しく現代的なダークモード配色を採用し、長時間のプレイに適した洗練されたデザインを実現しています。

#### ゲーム要素の色
| 要素 | 色 | RGB | 備考 |
|------|----|----|------|
| 背景（床） | `#1a1a1a` | (26, 26, 26) | ダークグレーの落ち着いた背景 |
| 壁・障害物 | `#4a4a4a` | (74, 74, 74) | 中間グレーで視認性を確保 |
| 床タイル | `#2d2d2d` | (45, 45, 45) | 背景より僅かに明るい床面 |
| プレイヤー | `#7dd87d` | (125, 216, 125) | 鮮やかな緑で主人公を強調 |
| 敵 | `#e74c3c` | (231, 76, 60) | 温かい赤で危険性を表現 |
| アイテム（一般） | `#f39c12` | (243, 156, 18) | 温かいオレンジで発見しやすく |
| ポーション | `#9b59b6` | (155, 89, 182) | 神秘的な紫色 |
| 武器 | `#e67e22` | (230, 126, 34) | 力強いオレンジ |
| 防具 | `#3498db` | (52, 152, 219) | 信頼できる青色 |
| 金貨 | `#f1c40f` | (241, 196, 15) | 輝く金色 |
| 階段 | `#ecf0f1` | (236, 240, 241) | 明るいグレーで目標を明示 |

#### UI要素の色
| 要素 | 色 | RGB | 備考 |
|------|----|----|------|
| UI背景 | `#2c3e50` | (44, 62, 80) | 深いブルーグレーで情報パネル |
| UI枠線 | `#34495e` | (52, 73, 94) | コントラストを保つ枠線 |
| メインテキスト | `#ecf0f1` | (236, 240, 241) | 明るく読みやすいテキスト |
| セカンダリテキスト | `#bdc3c7` | (189, 195, 199) | 補助情報用の控えめなテキスト |
| 戦闘メッセージ | `#e74c3c` | (231, 76, 60) | 戦闘ログは赤で緊迫感を演出 |
| アイテムメッセージ | `#f39c12` | (243, 156, 18) | アイテム関連は暖色で親しみやすく |
| システムメッセージ | `#95a5a6` | (149, 165, 166) | システム情報は落ち着いたグレー |
| ヘルスバー | `#e74c3c` | (231, 76, 60) | 体力は重要な赤色 |
| マナバー | `#3498db` | (52, 152, 219) | 魔力は神秘的な青色 |

### メッセージエリア
- **背景色**: `#34495e` (深いグレーブルー)
- **枠線**: `#7f8c8d` (ミディアムグレー)
- **パディング**: 8px
- **フォントサイズ**: 11px
- **行間**: 1.3

### オーディオコントロール
- **背景色**: `#34495e` (統一されたUI背景)
- **枠線**: `#7f8c8d` (統一された枠線色)
- **ボタン背景**: `#2c3e50` (主要UIカラー)
- **ボタンテキスト**: `#ecf0f1` (読みやすいライトテキスト)
- **ホバー効果**: `#34495e` (インタラクションフィードバック)

### カラーデザイン哲学
1. **目の疲労軽減**: 高コントラストながら眩しすぎない配色
2. **情報階層**: 重要度に応じた色の明度・彩度調整
3. **一貫性**: UI全体で統一されたカラーテーマ
4. **アクセシビリティ**: 色覚多様性に配慮した色選択
5. **ゲーム性**: クラシックRogueの雰囲気を保ちつつ現代的な洗練

### レイアウト設計
- **レスポンシブ対応**: モバイルから大画面まで対応
- **センタリング**: ゲーム画面を中央配置、スクロール不要
- **固定比率**: ゲーム画面とUI情報パネルの比率を最適化
- **等幅フォント**: `Courier New` でレトロゲーム感を演出

---

## 💻 技術仕様 (Technical Specifications)

### クラス構造

#### `AudioManager`クラス（サウンドシステム）
```javascript
class AudioManager {
    // コンストラクタ・初期化
    constructor()
    init()
    doInit()
    
    // 音響制御
    setVolume(volume)
    toggleMute()
    createMasterGain()
    
    // プロシージャル音響生成
    createProceduralSounds()
    generateSoundEffects()
    createProceduralSound(params)
    playProceduralSound(params)
    
    // 効果音再生
    playSound(name)               // 各種ゲームアクション音を再生
    
    // 背景音楽
    generateBackgroundMusic()
    startBackgroundMusic()
    stopBackgroundMusic()
    
    // ユーティリティ
    createOscillator(frequency, type)
    createNoiseBuffer()
}
```

#### `Game`クラス（メインゲームエンジン）
```javascript
class Game {
    // コンストラクタ・初期化
    constructor()
    init()
    setupEventListeners()
    
    // ゲームループ・入力処理
    handleInput(e)
    handleItemSelection(e)    // 新機能: アイテム選択モード
    processTurn()
    
    // プレイヤー制御
    movePlayer(dx, dy)
    pickupItem()
    useItem()                 // 旧来のアイテム使用
    
    // 新アイテムシステム
    startItemSelection()      // アイテム選択モード開始
    useItemByIndex(index)     // インデックス指定使用
    removeItemFromInventory(itemId) // 安全なアイテム削除
    
    // 装備システム
    equipItem(item)
    unequipItem(slot)
    showEquipment()
    removeEquipment()
    updatePlayerStats()
    
    // 戦闘・レベリング
    combat(attacker, defender)
    checkLevelUp()
    
    // GAMEOVER・ゲーム状態管理（新機能）
    gameOver(killer)          // ゲームオーバー処理（キラー情報付き）
    showGameOverScreen(killer) // GAMEOVER画面表示
    calculateFinalScore()     // 最終スコア計算
    getGameStats()           // ゲーム統計取得
    restart()                // ゲーム再開
    
    // ダンジョン・階層管理
    generateDungeon()
    descendStairs()           // 新機能: 階層進行
    carveRoom(room)
    connectRooms(room1, room2)
    
    // エンティティ管理
    createPlayer()
    spawnEnemies()
    spawnItems()
    
    // レンダリング・UI
    render()
    renderTile(x, y, tile)
    renderEntity(x, y, symbol, color)
    updateUI()
    addMessage(text, type)
    updateMessages()
    toggleInventory()
    
    // 新インベントリUIシステム（新機能）
    showInventoryUI()         // 専用インベントリUIを表示
    hideInventoryUI()         // インベントリUIを非表示
    createInventoryUI()       // インベントリUIの作成
    createInventoryItemElement() // アイテム要素の作成
    updateInventoryUI()       // インベントリUIの更新
    removeInventoryUI()       // インベントリUIの削除
    handleInventoryInput()    // インベントリUI内での入力処理
    dropItem()                // アイテムドロップ機能
    
    // ユーティリティ
    random(min, max)
    gameOver()
}
```

### データ構造

#### ゲームステート
```javascript
game = {
    canvas: HTMLCanvasElement,    // ゲーム描画キャンバス
    ctx: CanvasRenderingContext2D, // 描画コンテキスト
    tileSize: 16,                 // タイル1つのピクセルサイズ
    mapWidth: 40,                 // マップ幅（タイル数）
    mapHeight: 40,                // マップ高さ（タイル数）
    viewWidth: number,            // 表示範囲幅
    viewHeight: number,           // 表示範囲高さ
    
    player: Object,               // プレイヤーオブジェクト
    dungeon: Array[Array],        // 2次元マップ配列
    entities: Array,              // 敵エンティティ配列
    items: Array,                 // アイテム配列
    rooms: Array,                 // 部屋情報配列
    
    turn: number,                 // 現在ターン数
    floor: number,                // 現在階層（新機能）
    gameState: string,            // ゲーム状態 ('playing', 'dead', 'gameover')
    itemSelectionMode: boolean,   // アイテム選択モード中フラグ（新機能）
    inventoryUIActive: boolean,   // インベントリUI表示フラグ（新機能）
    gameOverActive: boolean,      // GAMEOVER画面表示フラグ（新機能）
    nextItemId: number,           // グローバルアイテムIDカウンター（新機能）
    
    audioManager: AudioManager,   // サウンドシステム（新機能）
    
    messages: Array,              // メッセージログ
    maxMessages: 50,              // 最大メッセージ保持数
    colors: {                     // ダークモードカラーパレット定義
        background: '#1a1a1a',    // ダークグレー背景
        wall: '#4a4a4a'          // ミディアムグレーの壁
        floor: '#2d2d2d'         // ダークグレーの床
        door: '#6a9bd1'          // ソフトブルーのドア/通路
        player: '#7dd87d'        // 明るい緑のプレイヤー
        enemy: '#e74c3c'         // 温かい赤の敵
        item: '#f39c12'          // 温かいオレンジのアイテム
        potion: '#9b59b6'        // 紫のポーション
        weapon: '#e67e22'        // オレンジの武器
        armor: '#3498db'         // 青の防具
        gold: '#f1c40f'          // 金色のゴールド
        stairs: '#ecf0f1'        // ライトグレーの階段
        text: '#ecf0f1'          // メインテキスト色
        textSecondary: '#bdc3c7' // セカンダリテキスト色
        ui: '#34495e'             // UI要素色
    }
}
```

#### プレイヤーオブジェクト
```javascript
player = {
    x: number,           // X座標
    y: number,           // Y座標  
    hp: number,          // 現在HP
    maxHp: number,       // 最大HP
    mp: number,          // 現在MP
    maxMp: number,       // 最大MP
    baseAttack: number,  // 基本攻撃力（新機能）
    baseDefense: number, // 基本防御力（新機能）
    attack: number,      // 計算済み攻撃力（基本値+装備ボーナス）
    defense: number,     // 計算済み防御力（基本値+装備ボーナス）
    level: number,       // レベル
    experience: number,  // 現在経験値
    experienceToNext: number, // 次のレベルまでの必要経験値
    gold: number,        // 所持金
    inventory: Array,    // アイテム配列
    equipment: {         // 装備スロット
        weapon: Object,  // 装備中の武器
        armor: Object    // 装備中の防具
    },
    symbol: string,      // 表示記号
    color: string,       // 表示色
    rest: function       // 休憩メソッド
}
```

#### 敵オブジェクト
```javascript
enemy = {
    name: string,        // 敵の名前
    symbol: string,      // 表示記号
    x: number,           // X座標
    y: number,           // Y座標
    hp: number,          // HP
    attack: number,      // 攻撃力
    defense: number,     // 防御力
    experience: number,  // 与える経験値
    gold: number,        // ドロップ金額
    type: 'enemy',       // エンティティ種別
    alive: boolean,      // 生存状態
    color: string        // 表示色
}
```

#### アイテムオブジェクト
```javascript
item = {
    name: string,        // アイテム名
    symbol: string,      // 表示記号
    x: number,           // X座標（マップ上配置時）
    y: number,           // Y座標（マップ上配置時）
    type: string,        // アイテム種別 ('potion', 'weapon', 'armor', 'gold')
    effect: string,      // 効果種別 ('heal', 'mana')
    value: number,       // 効果値・金額
    attack: number,      // 武器の攻撃力ボーナス
    defense: number,     // 防具の防御力ボーナス
    color: string,       // 表示色
    id: number           // 一意識別子（新機能: グローバルカウンター）
}
```

### アイテムID管理システム（新機能）
```javascript
// グローバルアイテムIDシステム
this.nextItemId = 0;  // ゲーム開始時に0で初期化

// アイテム生成時
item.id = this.nextItemId++;  // 自動インクリメント

// 安全な削除メソッド
removeItemFromInventory(itemId) {
    // ID照合による確実な削除
    // 削除前後の詳細ログ出力
    // エラーハンドリングと警告
}
```

### 描画システム
- **Canvas API**: HTML5 Canvasを使用した2D描画
- **フォント**: `monospace`（等幅フォント）
- **カメラシステム**: プレイヤー中心の追従カメラ
- **座標系**: ワールド座標とスクリーン座標の変換

### メッセージシステム
- **最大保持数**: 50メッセージ
- **表示数**: 最新10メッセージ
- **種類**: `system`, `combat`, `item`
- **色分け**: 種類別の色分け表示
- **自動スクロール**: 新メッセージ追加時に自動で最下部にスクロール

### アイテム選択UI（新機能）
- **選択モード表示**: `U`キー押下時に詳細なアイテム一覧を表示
- **効果値表示**: 各アイテムの具体的な効果数値を表示
  - 例: `"1: ! Health Potion (HP +30)"`
  - 例: `"2: / Sword (Attack +5)"`
- **操作案内**: 使用方法とキャンセル方法を明示
- **即座使用**: 数字キー（1-9）による直接アイテム使用

### インベントリUIシステム（新機能）
- **専用オーバーレイ**: `I`キー押下時にモダンなインベントリ画面を表示
- **インタラクティブ操作**: クリック操作とキーボード操作の両対応
- **装備中アイテムの強調表示**: 装備中のアイテムに[EQUIPPED]ラベルとボーダー強調
- **智能制限表示**: HP/MP満タン時の使用不可表示、ボタン無効化
- **レスポンシブ対応**: モバイル・デスクトップ両対応のUI設計

### デバッグ・ログシステム（新機能）
- **アイテム操作ログ**: アイテムの追加・削除・使用をコンソールログに詳細出力
- **ID追跡**: 各アイテムのユニークIDを追跡・表示
- **エラー検出**: アイテム削除失敗時の詳細警告とインベントリ状態出力
- **デバッグ情報**: インベントリ内容の詳細表示（アイテム名+ID）

### サウンドシステム（新機能）
#### プロシージャル音響生成
- **Web Audio API使用**: モダンなブラウザ音響システム
- **動的音響生成**: リアルタイムでの効果音合成
- **音響パラメータ**: 周波数・持続時間・波形タイプによる音響定義
- **エフェクト種類**: 
  - 移動音（footstep）: 200Hz ノイズ 0.1秒
  - 戦闘音（combat）: 300Hz 矩形波 0.3秒  
  - レベルアップ音（levelUp）: 和音（440/554/659Hz）正弦波 0.5秒
  - アイテム取得音（itemPickup）: 660Hz 正弦波 0.2秒
  - 敵死亡音（enemyDeath）: 150Hz 鋸歯状波 0.4秒
  - ダメージ音（damage）: 180Hz 三角波 0.2秒
  - 回復音（heal）: 和音（523/659/784Hz）正弦波 0.4秒
  - 階段音（stairs）: 和音（330/415/523Hz）三角波 0.6秒

#### 音響制御機能
- **音量調整**: マスターボリューム調整（Vキー）
- **ミュート機能**: 音響のオン・オフ切り替え（Mキー）
- **BGM**: 自動生成による環境音楽
- **ユーザーインタラクション対応**: ブラウザのautoplay制限に対応

---

## 🔧 拡張予定機能 (Future Versions)

### 🎯 **Phase 1: コマンドシステム拡張** *(v2.0.0 予定)*

#### **移動システム強化**
- **オリジナルRogue準拠の移動キー**: `hjklyubn` (vi形式) 対応
  - `h`,`j`,`k`,`l`: 上下左右移動
  - `y`,`u`,`b`,`n`: 斜め移動 (8方向完全対応)
- **連続移動システム**: 大文字キー (`H`,`J`,`K`,`L`,`Y`,`U`,`B`,`N`) で障害物まで連続移動
- **探索移動**: `Ctrl+方向キー` で「興味深いもの」まで移動
- **待機・探索**:
  - `.` (ピリオド): 1ターン待機
  - `s`: 周囲8方向の隠し扉・罠探索

#### **戦闘システム拡張**
- **投擲システム**: `t` + 方向キーで武器・アイテム投擲
- **連続戦闘**: `f` + 方向キーで敵が死ぬまで戦闘継続
- **素手移動**: `m` + 方向キーでアイテムを取らずに移動

#### **アイテム操作拡張**
- **個別アイテム情報**: `I` (大文字) でインベントリ内単一アイテム詳細表示
- **アイテム呼称**: `c` でアイテムに任意の名前付け
- **アイテム識別**: `D` で発見済みアイテム種別表示
- **装備情報表示**:
  - `)`: 現在の武器表示
  - `]`: 現在の防具表示
  - `=`: 現在の指輪表示

### 🎒 **Phase 2: 完全アイテムシステム** *(v2.1.0 予定)*

#### **ポーション類** *(現在: 2種類 → 目標: 14種類)*
```
現在実装: Health Potion, Mana Potion
未実装: 
- 回復: extra healing, healing, restore strength
- 能力: gain strength, increase level, poison, blindness
- 検知: see invisible, confusion, paralysis
- 特殊: haste self, slow self, levitation
```

#### **スクロール類** *(現在: 0種類 → 目標: 18種類)*
```
未実装全種類:
- 強化: enchant weapon, enchant armor, identify
- 魔法: magic mapping, teleportation, remove curse
- 攻撃: lightning bolt, fire ball, slow monster
- 作成: create monster, food detection, gold detection
- 防御: scare monster, hold monster, sleep
- 探索: genocide, light, darkness, aggravate monsters
```

#### **指輪類** *(現在: 0種類 → 目標: 14種類)*
```
未実装全種類:
- 能力系: add strength, dexterity, increase damage, protection
- 検知系: see invisible, searching, stealth
- 回復系: slow digestion, regeneration, sustain strength
- 移動系: teleportation, aggravate monster
- 特殊系: maintain armor, adornment
```

#### **杖・魔法棒類** *(現在: 0種類 → 目標: 14種類)*
```
未実装全種類:
- 攻撃系: magic missile, fire, ice, lightning
- 制御系: slow monster, haste monster, teleport away
- 検知系: invisibility, polymorph, cancellation
- 特殊系: drain life, nothing, striking, wonder
```

#### **武器類** *(現在: 1種類 → 目標: 9種類)*
```
現在実装: Sword (基本武器)
未実装:
- 刀剣類: two handed sword, long sword, short bow
- 射撃武器: bow, arrow, dagger, rock
- 重武器: mace (メイス)
```

#### **防具類** *(現在: 1種類 → 目標: 8種類)*
```
現在実装: Shield (基本防具)
未実装:
- 軽装: leather armor, studded leather armor
- 中装: ring mail, scale mail, chain mail
- 重装: banded mail, splint mail, plate mail
```

### 🐉 **Phase 3: 完全モンスターシステム** *(v2.2.0 予定)*

#### **モンスター種族拡張** *(現在: 基本敵 → 目標: 26種類 A-Z)*
```
オリジナルRogue準拠 26種族:
A: Aquator     B: Bat         C: Centaur     D: Dragon
E: Emu         F: Venus Flytrap G: Griffin    H: Hobgoblin
I: Ice Monster J: Jabberwock  K: Kestrel     L: Leprechaun
M: Medusa      N: Nymph       O: Orc         P: Phantom
Q: Quagga      R: Rattlesnake S: Snake       T: Troll
U: Umber Hulk  V: Vampire     W: Wraith      X: Xeroc
Y: Yeti        Z: Zombie
```

#### **モンスター特殊能力**
```
実装予定特殊能力:
- ドレイン系: 経験値ドレイン (Wraith)、金ドレイン (Leprechaun)
- 状態異常: 毒 (Snake)、麻痺 (Griffin)、混乱 (Nymph)
- 魔法使用: テレポート (Phantom)、分裂 (Xeroc)
- 環境操作: 腐食 (Aquator)、アイテム盗取 (Nymph)
- 特殊移動: 飛行 (Bat)、位相移動 (Phantom)
```

### 🎮 **Phase 4: 高度ゲームシステム** *(v2.3.0 予定)*

#### **視界・探索システム**
- **視線システム**: 壁・障害物による視界遮蔽
- **光源システム**: 明度による視認距離変化
- **隠し要素発見**:
  - 隠し扉: 探索で発見 (`s`キー)
  - 罠システム: 13種類の罠 (毒針、落とし穴、テレポート等)
  - 秘密通路: 特定条件で発見

#### **呪いシステム**
- **呪われたアイテム**: 装備すると外せない
- **呪い識別**: 装備時に判明または identify スクロール使用
- **呪い解除**: remove curse スクロール

#### **食料・疲労システム**
- **食料システム**: 行動により空腹度増加
- **疲労システム**: 空腹時の能力低下
- **食料アイテム**: food ration

#### **オプションシステム**
```
オリジナルRogue準拠オプション (o キー):
- terse: メッセージ簡略化
- jump: 階段で自動下降
- flush: バッファクリア
- seefloor: 床文字表示
- passgo: 通路での自動移動
- tombstone: 墓石表示
- inven: インベントリ表示方式 (overwrite/slow/clear)
- name: プレイヤー名
- fruit: 好物設定
- file: セーブファイル名
```

### 🎯 **Phase 5: UI/UX拡張** *(v2.4.0 予定)*

#### **クラシックrogue風UI強化**
- **キーヘルプシステム**: `?` キーで全コマンド一覧表示
- **ステータス詳細**: `@` キーで詳細ステータス表示
- **メッセージ履歴**: `Ctrl+P` で過去メッセージ表示
- **画面制御**: `Ctrl+R` で画面再描画

#### **セーブ・ロードシステム**
- **自動セーブ**: 階段移動時・重要イベント時
- **セーブスロット**: 複数キャラクター対応
- **クイックセーブ**: `S` キーで即座セーブ
- **終了時セーブ**: `Q` キー (確認付き終了)

#### **得点・統計システム**
- **ハイスコア記録**: 最高得点・最深階層記録
- **プレイ統計**: 総プレイ時間・キャラクター数・撃破モンスター統計
- **実績システム**: 特定条件達成で実績解除

### 🔮 **Phase 6: 拡張コンテンツ** *(v3.0.0+ 予定)*

#### **追加ダンジョン要素**
- **特殊部屋**: 宝物庫・図書館・武器庫・迷路部屋
- **階層バリエーション**: テーマ別階層 (氷・炎・毒沼・暗闇)
- **ボス階層**: 固定階層でのユニークモンスター

#### **マルチプレイヤー要素**
- **ローカル協力**: 2人協力プレイ
- **ターン制競争**: 交互プレイによるスコア競争
- **ゴースト機能**: 他プレイヤーの記録再生

---

### 📋 **実装優先度**

#### **🔥 最高優先度 (v2.0.0)**
1. vi形式移動キー (`hjklyubn`) 対応
2. 基本投擲システム (`t` キー)
3. スクロール・ポーション基本種追加 (各5種類程度)

#### **⭐ 高優先度 (v2.1.0)**
1. 指輪システム完全実装
2. モンスター種族拡張 (15種類程度)
3. 呪いシステム基本実装

#### **📈 中優先度 (v2.2.0)**
1. 視界・光源システム
2. 罠システム実装
3. オプションシステム基本機能

#### **🎯 低優先度 (v2.3.0+)**
1. 特殊部屋・ボス要素
2. マルチプレイヤー機能
3. 追加ゲームモード

---

*この仕様書は開発の進行に合わせて随時更新されます。*

---

## 📊 **オリジナルRogue 5.4.4との比較分析**

### 🔍 **調査基準**
オリジナル『Rogue 5.4.4-ant-r1.1.2』の全ソースコードとドキュメントを詳細に調査し、現在の実装との差分を抽出。以下の観点で比較分析を実施：

1. **コマンドシステム** - 入力キー・操作体系
2. **アイテムシステム** - 種類・効果・使用方法
3. **モンスターシステム** - 種族・AI・特殊能力
4. **ゲームシステム** - 視界・罠・呪い・オプション
5. **UI/UXシステム** - 表示方式・インタラクション

---

## 🚀 **拡張予定機能 (Future Versions)**

### 🎯 **Phase 1: コマンドシステム拡張** *(v2.0.0 予定)*

#### **移動システム強化**
- **オリジナルRogue準拠の移動キー**: `hjklyubn` (vi形式) 対応
  - `h`,`j`,`k`,`l`: 上下左右移動
  - `y`,`u`,`b`,`n`: 斜め移動 (8方向完全対応)
- **連続移動システム**: 大文字キー (`H`,`J`,`K`,`L`,`Y`,`U`,`B`,`N`) で障害物まで連続移動
- **探索移動**: `Ctrl+方向キー` で「興味深いもの」まで移動
- **待機・探索**:
  - `.` (ピリオド): 1ターン待機
  - `s`: 周囲8方向の隠し扉・罠探索

#### **戦闘システム拡張**
- **投擲システム**: `t` + 方向キーで武器・アイテム投擲
- **連続戦闘**: `f` + 方向キーで敵が死ぬまで戦闘継続
- **素手移動**: `m` + 方向キーでアイテムを取らずに移動

#### **アイテム操作拡張**
- **個別アイテム情報**: `I` (大文字) でインベントリ内単一アイテム詳細表示
- **アイテム呼称**: `c` でアイテムに任意の名前付け
- **アイテム識別**: `D` で発見済みアイテム種別表示
- **装備情報表示**:
  - `)`: 現在の武器表示
  - `]`: 現在の防具表示
  - `=`: 現在の指輪表示

### 🎒 **Phase 2: 完全アイテムシステム** *(v2.1.0 予定)*

#### **ポーション類** *(現在: 2種類 → 目標: 14種類)*
```
現在実装: Health Potion, Mana Potion
未実装: 
- 回復: extra healing, healing, restore strength
- 能力: gain strength, increase level, poison, blindness
- 検知: see invisible, confusion, paralysis
- 特殊: haste self, slow self, levitation
```

#### **スクロール類** *(現在: 0種類 → 目標: 18種類)*
```
未実装全種類:
- 強化: enchant weapon, enchant armor, identify
- 魔法: magic mapping, teleportation, remove curse
- 攻撃: lightning bolt, fire ball, slow monster
- 作成: create monster, food detection, gold detection
- 防御: scare monster, hold monster, sleep
- 探索: genocide, light, darkness, aggravate monsters
```

#### **指輪類** *(現在: 0種類 → 目標: 14種類)*
```
未実装全種類:
- 能力系: add strength, dexterity, increase damage, protection
- 検知系: see invisible, searching, stealth
- 回復系: slow digestion, regeneration, sustain strength
- 移動系: teleportation, aggravate monster
- 特殊系: maintain armor, adornment
```

#### **杖・魔法棒類** *(現在: 0種類 → 目標: 14種類)*
```
未実装全種類:
- 攻撃系: magic missile, fire, ice, lightning
- 制御系: slow monster, haste monster, teleport away
- 検知系: invisibility, polymorph, cancellation
- 特殊系: drain life, nothing, striking, wonder
```

#### **武器類** *(現在: 1種類 → 目標: 9種類)*
```
現在実装: Sword (基本武器)
未実装:
- 刀剣類: two handed sword, long sword, short bow
- 射撃武器: bow, arrow, dagger, rock
- 重武器: mace (メイス)
```

#### **防具類** *(現在: 1種類 → 目標: 8種類)*
```
現在実装: Shield (基本防具)
未実装:
- 軽装: leather armor, studded leather armor
- 中装: ring mail, scale mail, chain mail
- 重装: banded mail, splint mail, plate mail
```

### 🐉 **Phase 3: 完全モンスターシステム** *(v2.2.0 予定)*

#### **モンスター種族拡張** *(現在: 基本敵 → 目標: 26種類 A-Z)*
```
オリジナルRogue準拠 26種族:
A: Aquator     B: Bat         C: Centaur     D: Dragon
E: Emu         F: Venus Flytrap G: Griffin    H: Hobgoblin
I: Ice Monster J: Jabberwock  K: Kestrel     L: Leprechaun
M: Medusa      N: Nymph       O: Orc         P: Phantom
Q: Quagga      R: Rattlesnake S: Snake       T: Troll
U: Umber Hulk  V: Vampire     W: Wraith      X: Xeroc
Y: Yeti        Z: Zombie
```

#### **モンスター特殊能力**
```
実装予定特殊能力:
- ドレイン系: 経験値ドレイン (Wraith)、金ドレイン (Leprechaun)
- 状態異常: 毒 (Snake)、麻痺 (Griffin)、混乱 (Nymph)
- 魔法使用: テレポート (Phantom)、分裂 (Xeroc)
- 環境操作: 腐食 (Aquator)、アイテム盗取 (Nymph)
- 特殊移動: 飛行 (Bat)、位相移動 (Phantom)
```

### 🎮 **Phase 4: 高度ゲームシステム** *(v2.3.0 予定)*

#### **視界・探索システム**
- **視線システム**: 壁・障害物による視界遮蔽
- **光源システム**: 明度による視認距離変化
- **隠し要素発見**:
  - 隠し扉: 探索で発見 (`s`キー)
  - 罠システム: 13種類の罠 (毒針、落とし穴、テレポート等)
  - 秘密通路: 特定条件で発見

#### **呪いシステム**
- **呪われたアイテム**: 装備すると外せない
- **呪い識別**: 装備時に判明または identify スクロール使用
- **呪い解除**: remove curse スクロール

#### **食料・疲労システム**
- **食料システム**: 行動により空腹度増加
- **疲労システム**: 空腹時の能力低下
- **食料アイテム**: food ration

#### **オプションシステム**
```
オリジナルRogue準拠オプション (o キー):
- terse: メッセージ簡略化
- jump: 階段で自動下降
- flush: バッファクリア
- seefloor: 床文字表示
- passgo: 通路での自動移動
- tombstone: 墓石表示
- inven: インベントリ表示方式 (overwrite/slow/clear)
- name: プレイヤー名
- fruit: 好物設定
- file: セーブファイル名
```

### 🎯 **Phase 5: UI/UX拡張** *(v2.4.0 予定)*

#### **クラシックrogue風UI強化**
- **キーヘルプシステム**: `?` キーで全コマンド一覧表示
- **ステータス詳細**: `@` キーで詳細ステータス表示
- **メッセージ履歴**: `Ctrl+P` で過去メッセージ表示
- **画面制御**: `Ctrl+R` で画面再描画

#### **セーブ・ロードシステム**
- **自動セーブ**: 階段移動時・重要イベント時
- **セーブスロット**: 複数キャラクター対応
- **クイックセーブ**: `S` キーで即座セーブ
- **終了時セーブ**: `Q` キー (確認付き終了)

#### **得点・統計システム**
- **ハイスコア記録**: 最高得点・最深階層記録
- **プレイ統計**: 総プレイ時間・キャラクター数・撃破モンスター統計
- **実績システム**: 特定条件達成で実績解除

### 🔮 **Phase 6: 拡張コンテンツ** *(v3.0.0+ 予定)*

#### **追加ダンジョン要素**
- **特殊部屋**: 宝物庫・図書館・武器庫・迷路部屋
- **階層バリエーション**: テーマ別階層 (氷・炎・毒沼・暗闇)
- **ボス階層**: 固定階層でのユニークモンスター

#### **マルチプレイヤー要素**
- **ローカル協力**: 2人協力プレイ
- **ターン制競争**: 交互プレイによるスコア競争
- **ゴースト機能**: 他プレイヤーの記録再生

---

### 📋 **実装優先度**

#### **🔥 最高優先度 (v2.0.0)**
1. vi形式移動キー (`hjklyubn`) 対応
2. 基本投擲システム (`t` キー)
3. スクロール・ポーション基本種追加 (各5種類程度)

#### **⭐ 高優先度 (v2.1.0)**
1. 指輪システム完全実装
2. モンスター種族拡張 (15種類程度)
3. 呪いシステム基本実装

#### **📈 中優先度 (v2.2.0)**
1. 視界・光源システム
2. 罠システム実装
3. オプションシステム基本機能

#### **🎯 低優先度 (v2.3.0+)**
1. 特殊部屋・ボス要素
2. マルチプレイヤー機能
3. 追加ゲームモード
